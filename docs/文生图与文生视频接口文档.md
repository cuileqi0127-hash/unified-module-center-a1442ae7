# 文生图与文生视频接口文档

本文档汇总文生图、文生视频及相关能力（图生视频、会话存储、文件上传）的全部接口说明。

---

## 一、文生图接口（Image Generation）

### 1.1 生成图片

**接口地址**：`POST /api/tu-zi/v1/images/generations`

**认证方式**：Bearer Token（API Key），不使用用户 token。

**请求头**：
- `Authorization`: `Bearer <API_KEY>`
- `Content-Type`: `application/json`

**请求体**（JSON）：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| model | string | 是 | 模型：`gpt-image-1.5` \| `gemini-3-pro-image-preview-hd` \| `doubao-seedream-4-5-251128` \| `kling-v1-5` |
| prompt | string | 是 | 文本提示词 |
| image | string[] | 否 | 参考图 URL 数组，默认 `[]` |
| n | number | 否 | 生成数量，默认 1 |
| size | string | 否 | 尺寸，见下方「尺寸说明」 |
| quality | string | 否 | 质量：gpt 为 `standard` \| `hd`；gemini 为 `1k` \| `2k` \| `4k`；即梦/可灵无此参数 |
| style | string | 否 | 仅 gpt：`vivid` \| `natural`；其他模型无 |
| response_format | string | 否 | 响应格式：`url` \| `b64_json`，默认 `url` |
| negative_prompt | string | 否 | 即梦/可灵负向提示（内部固定值） |
| steps | number | 否 | 即梦/可灵步数（内部固定） |
| cfg_scale | number | 否 | 即梦/可灵 CFG（内部固定） |

**尺寸说明**：
- **gpt-image-1.5**：`1:1`、`2:3`、`3:2`（API 格式：1x1、2x3、3x2）
- **gemini-3-pro-image-preview-hd**：`1x1`、`2x3`、`3x2`、`3x4`、`4x3`、`4x5`、`5x4`、`9x16`、`16x9`、`21x9`
- **doubao-seedream-4-5-251128**：`1024x1024`、`2048x2048`、`4096x4096`
- **kling-v1-5**：`1:1`～`16:9`（UI 冒号格式，API 转为 1x1～16x9）

**即梦固定参数**（不对外展示）：`negative_prompt`、`steps=50`、`cfg_scale=10`、`watermark=false`  
**可灵固定参数**（不对外展示）：`negative_prompt`、`steps=30`、`cfg_scale=10`、`watermark=false`

**响应**（成功）：

```json
{
  "data": [
    {
      "url": "https://...",
      "revised_prompt": "可选，仅 gpt 可能返回"
    }
  ],
  "created": 1234567890,
  "usage": { "prompt_tokens": 0, "completion_tokens": 0, "total_tokens": 0 }
}
```

- `data[].url`：图片地址  
- `data[].revised_prompt`：仅 GPT 可能返回修订后的提示词  

**错误响应**：
- `error.message`：错误信息  
- `error.type` / `error.code`：可选  

---

## 二、文生视频接口（Video Generation）

### 2.1 上传媒体文件（图片，用于图生视频）

**接口地址**：`POST /vod/upload`

**认证方式**：无需用户认证。

**请求体**：`multipart/form-data`

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| region | string | 否 | 区域，默认 `ap-guangzhou` |
| sub_app_id | string | 否 | 子应用 ID，默认 `1320866336` |
| media | File | 是 | 图片文件 |
| cover | string | 否 | 封面，可空 |

**响应**：
- `fileId`：上传后文件 ID，用于创建视频任务  
- `mediaUrl`、`coverUrl`：可选  

---

### 2.2 创建视频生成任务（文生视频）

**接口地址**：`POST /aigc/create`

**认证方式**：无需用户认证。

**请求体**（JSON）：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| model_name | string | 是 | 模型：`OS` \| `Kling` |
| model_version | string | 否 | 默认 `2.0` |
| prompt | string | 是 | 文本提示词 |
| duration | string | 否 | 时长：`4` \| `5` \| `8` \| `10` \| `12` 秒 |
| file_id | string | 否 | 图生视频时传入，来自 2.1 的 fileId |
| aspect_ratio | string | 否 | 比例：`1280x720`（16:9）、`720x1280`（9:16）、`1024x1024`（1:1） |

**响应**：
```json
{
  "Response": {
    "TaskId": "xxx",
    "RequestId": "xxx"
  }
}
```

- `TaskId`：用于轮询任务状态  

---

### 2.3 查询视频任务状态

**接口地址**：`POST /aigc/task`

**认证方式**：无需用户认证。

**请求体**（JSON）：
- `task_id`：string，任务 ID（来自 2.2 的 TaskId）

**响应**（简化）：
- `AigcVideoTask.Status`：`PROCESSING` \| `SUCCESS` \| `FAILED` 等  
- `AigcVideoTask.Progress`：0–100  
- `AigcVideoTask.Output.FileInfos[].FileUrl` 或 `Url`：完成时的视频地址  
- `AigcVideoTask.ErrCode`、`AigcVideoTask.Message`：失败时错误信息  

**统一状态映射**：
- `SUCCESS` / `COMPLETED` / `FINISH` → completed  
- `FAILED` / `ERROR` → failed  
- `PROCESSING` / `RUNNING` → processing  
- 其他 → queued  

---

## 三、图生视频 / 参考视频（Video Replication）

### 3.1 上传视频文件（参考视频）

**接口地址**：`POST /process/upload`

**认证方式**：请求头 `X-API-Key: <API_KEY>`，不使用用户 token。

**请求体**：`multipart/form-data`  
- `file`：视频文件  

**响应**：由后端返回的上传结果（含后续流程所需标识）。

---

### 3.2 上传媒体文件（图片，用于图生视频）

与 **2.1** 相同：`POST /vod/upload`，参数与响应一致，返回的 `fileId` 用于 3.3。

---

### 3.3 创建图生视频任务

**接口地址**：`POST /aigc/create`

**认证方式**：无需用户认证。

**请求体**（JSON）：
- `model_name`：固定 `OS`  
- `model_version`：固定 `2.0`  
- `prompt`：string，提示词  
- `file_id`：string，来自 3.2（或 2.1）的 fileId  

**响应**：与 2.2 相同，返回 `Response.TaskId`。

---

### 3.4 查询图生视频任务状态

与 **2.3** 相同：`POST /aigc/task`，请求与响应格式一致。

---

## 四、通用文件上传（OSS）

### 4.1 上传文件到 OSS

**接口地址**：`POST /common/oss/upload?type=1`

**认证方式**：可选 `Authorization: Bearer <用户 token>`。

**请求体**：`multipart/form-data`  
- `file`：文件  

**响应**（成功）：
```json
{
  "code": 0,
  "msg": "ok",
  "success": true,
  "timestamp": 1234567890,
  "data": {
    "ossKey": "xxx",
    "url": "https://..."
  }
}
```

- `data.ossKey`：OSS 存储 key  
- `data.url`：访问 URL  

---

## 五、生成会话与画布（Session API）

**Base URL**：`/api`（相对路径，经 Nginx 代理）。

**认证**：使用用户 token（apiClient 统一处理）。

---

### 5.1 分页查询会话

- **方法/路径**：`GET /api/tools/gen/sessions`  
- **Query**：`taskType=image|video`、`page`、`size`  
- **响应**：分页列表，每项为会话摘要（id、title、taskType、settings、canvasView、assetCount 等）。

---

### 5.2 创建会话

- **方法/路径**：`POST /api/tools/gen/sessions`  
- **请求体**：
  - `title`：string  
  - `taskType`：`image` \| `video`  
  - `settings`：{ model, size?, ... }  
  - `canvasView`：{ zoom, pan: { x, y } }  
- **响应**：创建的 Session 对象。

---

### 5.3 保存参考图（画布）

- **方法/路径**：`POST /api/tools/gen/sessions/:sessionId/references`  
- **请求体**：`{ "reference": { "type": "image"|"video", "sourceUrl", "ossKey?", "canvasItem": { x, y, width, height, rotate?, visible?, zindex? } } }`  
- **响应**：`assetId`、`canvasItemId`、`ossKey`、`downloadUrl`。

---

### 5.4 生成结果落库（新增消息并保存结果）

- **方法/路径**：`POST /api/tools/gen/sessions/:sessionId/messages`  
- **请求体**：
  - `generation`：{ model, size?, prompt, status }  
  - `asset`：{ type, sourceUrl, seq?, ossKey?, width?, height?, duration?, fps? }  
  - `message`：{ type, content, status?, resultSummary? }  
  - `canvasItem`：{ x, y, width, height, rotate?, visible?, zindex? }  
  - `references?`：参考图数组（可选）  
- **响应**：`generationId`、`assetId`、`messageId`、`canvasItemId`、`ossKey`、`downloadUrl`。

---

### 5.5 查询会话详情

- **方法/路径**：`GET /api/tools/gen/sessions/:sessionId`  
- **响应**：会话详情，含 `messages`、`generations`、`assets`、`canvasItems` 等关联数据。

---

### 5.6 更新会话

- **方法/路径**：`PATCH /api/tools/gen/sessions/:sessionId`  
- **请求体**：`title?`、`taskType?`、`settings?`、`canvasView?`（均为可选）  
- **响应**：通常为 204 或无 body。

---

### 5.7 更新画布元素

- **方法/路径**：`PATCH /api/tools/gen/canvas-items/:canvasItemId`  
- **请求体**：`x?`、`y?`、`width?`、`height?`、`rotate?`、`visible?`、`zindex?`  
- **响应**：通常为 204 或无 body。

---

### 5.8 删除画布元素

- **方法/路径**：`DELETE /api/tools/gen/canvas-items/:canvasItemId`  
- **响应**：通常为 204 或无 body。

---

### 5.9 批量删除画布元素

- **方法/路径**：`DELETE /api/tools/gen/canvas-items`  
- **请求体**：JSON 数组，元素为 canvasItemId（number）  
- **响应**：通常为 204 或无 body。

---

## 六、接口汇总表

| 能力 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 文生图 | POST | /api/tu-zi/v1/images/generations | 生成图片（API Key） |
| 文生视频-上传 | POST | /vod/upload | 上传图片获取 fileId |
| 文生视频-创建 | POST | /aigc/create | 创建视频任务 |
| 文生视频-状态 | POST | /aigc/task | 查询任务状态 |
| 图生视频-上传 | POST | /process/upload | 上传视频（X-API-Key） |
| 图生视频-创建/状态 | POST | /aigc/create、/aigc/task | 同文生视频 |
| OSS 上传 | POST | /common/oss/upload?type=1 | 通用文件上传（可选用户 token） |
| 会话列表 | GET | /api/tools/gen/sessions | 分页查询会话 |
| 创建会话 | POST | /api/tools/gen/sessions | 创建会话 |
| 保存参考图 | POST | /api/tools/gen/sessions/:id/references | 保存参考图与画布项 |
| 结果落库 | POST | /api/tools/gen/sessions/:id/messages | 生成结果与消息落库 |
| 会话详情 | GET | /api/tools/gen/sessions/:id | 会话详情 |
| 更新会话 | PATCH | /api/tools/gen/sessions/:id | 更新会话 |
| 更新画布元素 | PATCH | /api/tools/gen/canvas-items/:id | 更新画布元素 |
| 删除画布元素 | DELETE | /api/tools/gen/canvas-items/:id | 删除单个 |
| 批量删除画布元素 | DELETE | /api/tools/gen/canvas-items | Body 为 id 数组 |

---

## 七、附录：模型与参数速查

**文生图模型**：
- gpt-image-1.5：size 1:1/2:3/3:2，quality standard/hd，style vivid/natural  
- gemini-3-pro-image-preview-hd：size 1x1～21x9，quality 1k/2k/4k  
- doubao-seedream-4-5-251128：size 1024x1024/2048x2048/4096x4096  
- kling-v1-5：aspect_ratio 1:1～16:9  

**文生视频**：
- 模型：OS、Kling  
- 时长：4/5/8/10/12 秒  
- 比例：16:9（1280x720）、9:16（720x1280）、1:1（1024x1024）  

**图生视频**：使用同一套 `/vod/upload` + `/aigc/create` + `/aigc/task`，创建任务时必传 `file_id`。
